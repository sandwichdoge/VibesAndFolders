name: Build VibesAndFolders

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  release:
    types: [created]

permissions:
  contents: write

jobs:
  build:
    name: Build ${{ matrix.os }}
    runs-on: ${{ matrix.runner }}
    
    strategy:
      matrix:
        include:
          - os: linux
            runner: ubuntu-latest
            artifact: VibesAndFolders-linux-amd64.tar.gz
            binary: VibesAndFolders
          - os: windows
            runner: windows-latest
            artifact: VibesAndFolders-windows-amd64.zip
            binary: VibesAndFolders.exe
          - os: macos
            runner: macos-latest
            artifact: VibesAndFolders-macOS.zip
            binary: VibesAndFolders.app

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: 'stable'

      # Install platform-specific dependencies
      - name: Install Linux dependencies
        if: matrix.os == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc libgl1-mesa-dev xorg-dev

      - name: Install macOS dependencies
        if: matrix.os == 'macos'
        run: |
          echo "macOS build environment ready"

      # Build the application - simple go build with proper flags
      - name: Build Linux Binary
        if: matrix.os == 'linux'
        run: |
          cd cmd/vibesandfolders
          go build -ldflags="-s -w" -o ../../VibesAndFolders
          cd ../..

      - name: Build Windows Binary
        if: matrix.os == 'windows'
        shell: pwsh
        run: |
          cd cmd/vibesandfolders
          go build -ldflags="-s -w -H windowsgui" -o ../../VibesAndFolders.exe
          cd ../..

      - name: Build macOS App Bundle
        if: matrix.os == 'macos'
        run: |
          # Install fyne CLI for packaging
          go install fyne.io/tools/cmd/fyne@latest
          cd cmd/vibesandfolders
          # Use fyne package for macOS to get proper .app bundle
          ~/go/bin/fyne package -os darwin -icon ../../Icon.png
          if [ -d "vibesandfolders.app" ]; then
            mv vibesandfolders.app ../../VibesAndFolders.app
          elif [ -d "VibesAndFolders.app" ]; then
            mv VibesAndFolders.app ../../VibesAndFolders.app
          fi
          cd ../..

      # Verify builds exist
      - name: Verify Linux Build
        if: matrix.os == 'linux'
        run: |
          ls -lh VibesAndFolders
          file VibesAndFolders

      - name: Verify Windows Build
        if: matrix.os == 'windows'
        shell: pwsh
        run: |
          if (Test-Path "VibesAndFolders.exe") {
            Write-Host "✓ VibesAndFolders.exe created"
            Get-Item VibesAndFolders.exe | Select-Object Name, Length
          } else {
            Write-Error "VibesAndFolders.exe not found!"
            exit 1
          }

      - name: Verify macOS Build
        if: matrix.os == 'macos'
        run: |
          if [ -d "VibesAndFolders.app" ]; then
            echo "✓ VibesAndFolders.app created"
            ls -lh VibesAndFolders.app/Contents/MacOS/
          else
            echo "ERROR: VibesAndFolders.app not found!"
            exit 1
          fi

      # Upload artifacts for non-release builds (raw binaries/bundles)
      - name: Upload Artifacts (CI)
        if: github.event_name != 'release'
        uses: actions/upload-artifact@v4
        with:
          name: VibesAndFolders-${{ matrix.os }}
          path: |
            VibesAndFolders
            VibesAndFolders.exe
            VibesAndFolders.app

      # Package for releases - simple, clean archives
      - name: Package Linux Build for Release
        if: github.event_name == 'release' && matrix.os == 'linux'
        run: |
          tar -czf ${{ matrix.artifact }} VibesAndFolders
          ls -lh ${{ matrix.artifact }}

      - name: Package Windows Build for Release
        if: github.event_name == 'release' && matrix.os == 'windows'
        shell: pwsh
        run: |
          Compress-Archive -Path VibesAndFolders.exe -DestinationPath ${{ matrix.artifact }}
          Get-Item ${{ matrix.artifact }} | Select-Object Name, Length

      - name: Package macOS Build for Release
        if: github.event_name == 'release' && matrix.os == 'macos'
        run: |
          zip -r ${{ matrix.artifact }} VibesAndFolders.app
          ls -lh ${{ matrix.artifact }}

      # Upload to release if this is a release event
      - name: Upload Release Assets
        if: github.event_name == 'release'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh release upload ${{ github.event.release.tag_name }} ${{ matrix.artifact }} --clobber
