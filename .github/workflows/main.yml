name: Build VibesAndFolders

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  release:
    types: [created]

permissions:
  contents: write

jobs:
  build:
    name: Build Fyne Cross-Platform
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: 'stable'

      - name: Install fyne-cross
        run: make install-tools

      # --- LINUX ---
      - name: Build Linux
        run: make build-linux

      # --- WINDOWS ---
      - name: Build Windows
        run: make build-windows

      # --- MACOS (Fixed with SDK) ---
      - name: Download macOS SDK
        run: |
          # Download a packaged SDK (MacOSX 12.3 is a safe standard)
          wget -q https://github.com/joseluisq/macosx-sdks/releases/download/12.3/MacOSX12.3.sdk.tar.xz
          tar -xf MacOSX12.3.sdk.tar.xz

      - name: Build macOS
        # We run the command manually here to inject the -sdk flag
        # (bypassing 'make build-mac' to avoid editing your Makefile)
        run: fyne-cross darwin -sdk $(pwd)/MacOSX12.3.sdk ./cmd/vibesandfolders

      # --- PACKAGING ---
      - name: Package Linux Build
        run: |
          cd fyne-cross/bin/linux-amd64
          tar czvf ../../../VibesAndFolders-linux-amd64.tar.gz *

      - name: Package Windows Build
        run: |
          cd fyne-cross/bin/windows-amd64
          zip -r ../../../VibesAndFolders-windows-amd64.zip *

      - name: Package macOS Build
        run: |
          # Fyne-cross darwin output is usually a .app folder or a binary inside darwin-universal or darwin-amd64
          # We check specifically for the universal folder or amd64
          if [ -d "fyne-cross/bin/darwin-universal" ]; then
             cd fyne-cross/bin/darwin-universal
          elif [ -d "fyne-cross/bin/darwin-amd64" ]; then
             cd fyne-cross/bin/darwin-amd64
          fi
          zip -r ../../../VibesAndFolders-macOS.zip *

      # --- UPLOAD ARTIFACTS ---
      - name: Upload Artifacts (CI)
        if: github.event_name != 'release'
        uses: actions/upload-artifact@v4
        with:
          name: VibesAndFolders-Builds
          path: |
            VibesAndFolders-*.zip
            VibesAndFolders-*.tar.gz

      # --- RELEASE ---
      - name: Upload Release Assets
        if: github.event_name == 'release'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload ${{ github.event.release.tag_name }} \
            VibesAndFolders-linux-amd64.tar.gz \
            VibesAndFolders-windows-amd64.zip \
            VibesAndFolders-macOS.zip \
            --clobber
